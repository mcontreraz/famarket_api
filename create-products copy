const WooCommerceAPI = require("woocommerce-api");
const dbConnection = require("./db-connection.js");
const dotenv = require("dotenv");
dotenv.config();
const axios = require("axios");

const wooCommerce = new WooCommerceAPI({
  url: process.env.WOOCOMMERCE_URL,
  consumerKey: process.env.WOOCOMMERCE_KEY,
  consumerSecret: process.env.WOOCOMMERCE_SECRET,
  wpAPI: true,
  version: "wc/v3",
});

const defaultImageURL = "https://famarket.cl/prod_images/sinfoto.jpg"; // URL de la imagen por defecto

const createOrUpdateProduct = async (data, sku) => {
  try {
    const existingProduct = await wooCommerce.get(`products?sku=${sku}`);
    console.log(
      "ðŸš€ ~ file: create-products:21 ~ createOrUpdateProduct ~ existingProduct:",
      existingProduct.body
    );
    if (
      existingProduct &&
      Array.isArray(existingProduct.body) &&
      existingProduct.body.length > 0
    ) {
      const productId = existingProduct.body[0].id;
      await wooCommerce.put(`products/${productId}`, data);
      console.log(`Producto actualizado en WooCommerce con ID: ${productId}`);
    } else {
      await wooCommerce.post("products", data);
      console.log(`Producto creado en WooCommerce con SKU: ${sku}`);
    }
  } catch (error) {
    console.error(
      `Error al crear o actualizar el producto con SKU: ${sku}`,
      error
    );
    throw error;
  }
};

const createProductsFromTable = async (tableName) => {
  console.log("Creando o actualizando productos...");
  const query = `SELECT * FROM ${tableName}`;

  try {
    const results = await new Promise((resolve, reject) => {
      dbConnection.query(query, (error, results) => {
        if (error) {
          reject(error);
        } else {
          resolve(results);
        }
      });
    });

    for (const articulo of results) {
      const data = {
        name: articulo.desart,
        description: articulo.desart,
        regular_price: articulo.preart.toString(),
        manage_stock: true,
        stock_quantity: articulo.stoact,
        stock_status: "instock",
        sku: articulo.idart.toString(),
        categories: [
          {
            id: articulo.id_cat,
          },
        ],
        images: [],
      };

      const imageUrl = `https://famarket.cl/prod_images/${articulo.idart}.jpg`;
      const imageExists = await checkImageExists(imageUrl);

      if (imageExists) {
        data.images.push({ src: imageUrl });
      } else {
        data.images.push({ src: defaultImageURL });
      }

      await createOrUpdateProduct(data, articulo.idart.toString());

      // Agregar un retraso para no abrumar la API
      await new Promise((resolve) => setTimeout(resolve, 1000));
    }
  } catch (error) {
    console.error(
      "Error al crear o actualizar productos desde la tabla:",
      error
    );
  } finally {
    console.log("Productos creados o actualizados exitosamente.");
  }
};

// const createProductsFromTable = async (tableName) => {
//   console.log("Creando productos...");
//   const query = `SELECT * FROM ${tableName}`;
//   try {
//     const results = await new Promise((resolve, reject) => {
//       dbConnection.query(query, (error, results) => {
//         if (error) {
//           reject(error);
//         } else {
//           resolve(results);
//         }
//       });
//     });

//     for (const articulo of results) {
//       const data = {
//         name: articulo.desart,
//         description: articulo.desart,
//         regular_price: articulo.preart.toString(),
//         manage_stock: true,
//         stock_quantity: articulo.stoact,
//         stock_status: "instock",
//         sku: articulo.idart.toString(),
//         categories: [
//           {
//             id: articulo.id_cat,
//           },
//         ],
//         images: [],
//       };

//       const imageUrl = `https://famarket.cl/prod_images/${articulo.idart}.jpg`;

//       // Verificar si la imagen existe antes de agregarla al producto
//       const imageExists = await checkImageExists(imageUrl);

//       if (imageExists) {
//         data.images.push({ src: imageUrl });
//       } else {
//         data.images.push({ src: defaultImageURL });
//       }

//       await createProduct(data);

//       // Agregar un retraso
//       await new Promise((resolve) => setTimeout(resolve, 1000));
//     }
//   } catch (error) {
//     console.error("Error al crear productos desde la tabla:", error);
//   } finally {
//     console.log("Productos creados exitosamente.");
//   }
// };

const checkImageExists = async (imageUrl) => {
  try {
    const response = await axios.head(imageUrl);
    return response.status === 200;
  } catch (error) {
    return false;
  }
};

const createProduct = async (data) => {
  try {
    const response = await wooCommerce.post("products", data);
    console.log("Producto creado en WooCommerce...", response.body);
  } catch (error) {
    console.error("Error al crear el producto:", error);
    throw error;
  }
};
const tableName = "update_products";

createProductsFromTable(tableName);

module.exports = createProductsFromTable;
